/**
 * @fileoverview added by tsickle
 * Generated from: src/dataservices/entity-cache-data.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Optional } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { throwError } from 'rxjs';
import { catchError, delay, map, timeout } from 'rxjs/operators';
import { ChangeSetOperation, excludeEmptyChangeSetItems, } from '../actions/entity-cache-change-set';
import { DataServiceError } from './data-service-error';
import { DefaultDataServiceConfig } from './default-data-service-config';
import { EntityDefinitionService } from '../entity-metadata/entity-definition.service';
/** @type {?} */
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '../entity-metadata/entity-definition.service';
import * as ɵngcc2 from '@angular/common/http';
import * as ɵngcc3 from './default-data-service-config';
const updateOp = ChangeSetOperation.Update;
/**
 * Default data service for making remote service calls targeting the entire EntityCache.
 * See EntityDataService for services that target a single EntityCollection
 */
export class EntityCacheDataService {
    /**
     * @param {?} entityDefinitionService
     * @param {?} http
     * @param {?=} config
     */
    constructor(entityDefinitionService, http, config) {
        this.entityDefinitionService = entityDefinitionService;
        this.http = http;
        this.idSelectors = {};
        this.saveDelay = 0;
        this.timeout = 0;
        const { saveDelay = 0, timeout: to = 0 } = config || {};
        this.saveDelay = saveDelay;
        this.timeout = to;
    }
    /**
     * Save changes to multiple entities across one or more entity collections.
     * Server endpoint must understand the essential SaveEntities protocol,
     * in particular the ChangeSet interface (except for Update<T>).
     * This implementation extracts the entity changes from a ChangeSet Update<T>[] and sends those.
     * It then reconstructs Update<T>[] in the returned observable result.
     * @param {?} changeSet  An array of SaveEntityItems.
     * Each SaveEntityItem describe a change operation for one or more entities of a single collection,
     * known by its 'entityName'.
     * @param {?} url The server endpoint that receives this request.
     * @return {?}
     */
    saveEntities(changeSet, url) {
        changeSet = this.filterChangeSet(changeSet);
        // Assume server doesn't understand @ngrx/entity Update<T> structure;
        // Extract the entity changes from the Update<T>[] and restore on the return from server
        changeSet = this.flattenUpdates(changeSet);
        /** @type {?} */
        let result$ = this.http
            .post(url, changeSet)
            .pipe(map((/**
         * @param {?} result
         * @return {?}
         */
        (result) => this.restoreUpdates(result))), catchError(this.handleError({ method: 'POST', url, data: changeSet })));
        if (this.timeout) {
            result$ = result$.pipe(timeout(this.timeout));
        }
        if (this.saveDelay) {
            result$ = result$.pipe(delay(this.saveDelay));
        }
        return result$;
    }
    // #region helpers
    /**
     * @protected
     * @param {?} reqData
     * @return {?}
     */
    handleError(reqData) {
        return (/**
         * @param {?} err
         * @return {?}
         */
        (err) => {
            /** @type {?} */
            const error = new DataServiceError(err, reqData);
            return throwError(error);
        });
    }
    /**
     * Filter changeSet to remove unwanted ChangeSetItems.
     * This implementation excludes null and empty ChangeSetItems.
     * @protected
     * @param {?} changeSet ChangeSet with changes to filter
     * @return {?}
     */
    filterChangeSet(changeSet) {
        return excludeEmptyChangeSetItems(changeSet);
    }
    /**
     * Convert the entities in update changes from \@ngrx Update<T> structure to just T.
     * Reverse of restoreUpdates().
     * @protected
     * @param {?} changeSet
     * @return {?}
     */
    flattenUpdates(changeSet) {
        /** @type {?} */
        let changes = changeSet.changes;
        if (changes.length === 0) {
            return changeSet;
        }
        /** @type {?} */
        let hasMutated = false;
        changes = (/** @type {?} */ (changes.map((/**
         * @param {?} item
         * @return {?}
         */
        (item) => {
            if (item.op === updateOp && item.entities.length > 0) {
                hasMutated = true;
                return Object.assign(Object.assign({}, item), { entities: ((/** @type {?} */ (item))).entities.map((/**
                     * @param {?} u
                     * @return {?}
                     */
                    (u) => u.changes)) });
            }
            else {
                return item;
            }
        }))));
        return hasMutated ? Object.assign(Object.assign({}, changeSet), { changes }) : changeSet;
    }
    /**
     * Convert the flattened T entities in update changes back to \@ngrx Update<T> structures.
     * Reverse of flattenUpdates().
     * @protected
     * @param {?} changeSet
     * @return {?}
     */
    restoreUpdates(changeSet) {
        if (changeSet == null) {
            // Nothing? Server probably responded with 204 - No Content because it made no changes to the inserted or updated entities
            return changeSet;
        }
        /** @type {?} */
        let changes = changeSet.changes;
        if (changes.length === 0) {
            return changeSet;
        }
        /** @type {?} */
        let hasMutated = false;
        changes = (/** @type {?} */ (changes.map((/**
         * @param {?} item
         * @return {?}
         */
        (item) => {
            if (item.op === updateOp) {
                // These are entities, not Updates; convert back to Updates
                hasMutated = true;
                /** @type {?} */
                const selectId = this.getIdSelector(item.entityName);
                return (/** @type {?} */ (Object.assign(Object.assign({}, item), { entities: item.entities.map((/**
                     * @param {?} u
                     * @return {?}
                     */
                    (u) => ({
                        id: selectId(u),
                        changes: u,
                    }))) })));
            }
            else {
                return item;
            }
        }))));
        return hasMutated ? Object.assign(Object.assign({}, changeSet), { changes }) : changeSet;
    }
    /**
     * Get the id (primary key) selector function for an entity type
     * @protected
     * @param {?} entityName name of the entity type
     * @return {?}
     */
    getIdSelector(entityName) {
        /** @type {?} */
        let idSelector = this.idSelectors[entityName];
        if (!idSelector) {
            idSelector = this.entityDefinitionService.getDefinition(entityName)
                .selectId;
            this.idSelectors[entityName] = idSelector;
        }
        return idSelector;
    }
}
EntityCacheDataService.ɵfac = function EntityCacheDataService_Factory(t) { return new (t || EntityCacheDataService)(ɵngcc0.ɵɵinject(ɵngcc1.EntityDefinitionService), ɵngcc0.ɵɵinject(ɵngcc2.HttpClient), ɵngcc0.ɵɵinject(ɵngcc3.DefaultDataServiceConfig, 8)); };
EntityCacheDataService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: EntityCacheDataService, factory: EntityCacheDataService.ɵfac });
/** @nocollapse */
EntityCacheDataService.ctorParameters = () => [
    { type: EntityDefinitionService },
    { type: HttpClient },
    { type: DefaultDataServiceConfig, decorators: [{ type: Optional }] }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(EntityCacheDataService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.EntityDefinitionService }, { type: ɵngcc2.HttpClient }, { type: ɵngcc3.DefaultDataServiceConfig, decorators: [{
                type: Optional
            }] }]; }, null); })();
if (false) {
    /**
     * @type {?}
     * @protected
     */
    EntityCacheDataService.prototype.idSelectors;
    /**
     * @type {?}
     * @protected
     */
    EntityCacheDataService.prototype.saveDelay;
    /**
     * @type {?}
     * @protected
     */
    EntityCacheDataService.prototype.timeout;
    /**
     * @type {?}
     * @protected
     */
    EntityCacheDataService.prototype.entityDefinitionService;
    /**
     * @type {?}
     * @protected
     */
    EntityCacheDataService.prototype.http;
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LWNhY2hlLWRhdGEuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vbW9kdWxlcy9kYXRhL3NyYy9kYXRhc2VydmljZXMvZW50aXR5LWNhY2hlLWRhdGEuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUVsRCxPQUFPLEVBQWMsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzlDLE9BQU8sRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUlqRSxPQUFPLEVBQ0wsa0JBQWtCLEVBSWxCLDBCQUEwQixHQUMzQixNQUFNLG9DQUFvQyxDQUFDO0FBQzVDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3hELE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ3pFLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLDhDQUE4QyxDQUFDO0FBQ3ZGOzs7OztBQUFpQixNQUVYLFFBQVEsR0FBRyxrQkFBa0IsQ0FBQyxNQUFNO0FBQzFDO0FBQ0c7QUFDc0Y7QUFDZDtBQUczRSxNQUFNLE9BQU8sc0JBQXNCO0FBQ25DO0FBQVE7QUFBMEM7QUFDbEQ7QUFBMEI7QUFDbkIsSUFFTCxZQUNZLHVCQUFnRCxFQUNoRCxJQUFnQixFQUNkLE1BQWlDO0FBQzlDLFFBSFcsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtBQUFDLFFBQ2pELFNBQUksR0FBSixJQUFJLENBQVk7QUFBQyxRQU5uQixnQkFBVyxHQUE4QyxFQUFFLENBQUM7QUFDeEUsUUFBWSxjQUFTLEdBQUcsQ0FBQyxDQUFDO0FBQzFCLFFBQVksWUFBTyxHQUFHLENBQUMsQ0FBQztBQUN4QixjQU1VLEVBQUUsU0FBUyxHQUFHLENBQUMsRUFBRSxPQUFPLEVBQUUsRUFBRSxHQUFHLENBQUMsRUFBRSxHQUFHLE1BQU0sSUFBSSxFQUFFO0FBQzNELFFBQUksSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7QUFDL0IsUUFBSSxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztBQUN0QixJQUFFLENBQUM7QUFDSDtBQUVDO0FBQ0U7QUFDRTtBQUNFO0FBQ0U7QUFDRTtBQUNNO0FBQ0U7QUFDRTtBQUVBO0FBQW1CO0FBQVEsSUFBOUMsWUFBWSxDQUFDLFNBQW9CLEVBQUUsR0FBVztBQUFJLFFBQ2hELFNBQVMsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ2hELFFBQUkscUVBQXFFO0FBQ3pFLFFBQUksd0ZBQXdGO0FBQzVGLFFBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDL0M7QUFDd0IsWUFBaEIsT0FBTyxHQUEwQixJQUFJLENBQUMsSUFBSTtBQUNsRCxhQUFPLElBQUksQ0FBWSxHQUFHLEVBQUUsU0FBUyxDQUFDO0FBQ3RDLGFBQU8sSUFBSSxDQUNILEdBQUc7QUFBTTtBQUE2QjtBQUMvQjtBQUFZLFFBRGYsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLEVBQUMsRUFDNUMsVUFBVSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUN2RTtBQUNQLFFBQ0ksSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO0FBQ3RCLFlBQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0FBQ3BELFNBQUs7QUFDTCxRQUNJLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtBQUN4QixZQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztBQUNwRCxTQUFLO0FBQ0wsUUFDSSxPQUFPLE9BQU8sQ0FBQztBQUNuQixJQUFFLENBQUM7QUFDSDtBQUVDO0FBQVE7QUFBa0I7QUFDdEI7QUFBbUI7QUFDbkIsSUFGTyxXQUFXLENBQUMsT0FBb0I7QUFDNUMsUUFBSTtBQUFZO0FBQ0Q7QUFBdUI7QUFBWSxRQUR2QyxDQUFDLEdBQVEsRUFBRSxFQUFFO0FBQ3hCO0FBQTZCLGtCQUFqQixLQUFLLEdBQUcsSUFBSSxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDO0FBQ3RELFlBQU0sT0FBTyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDL0IsUUFBSSxDQUFDLEVBQUM7QUFDTixJQUFFLENBQUM7QUFDSDtBQUVDO0FBQ0U7QUFDRTtBQUFrQjtBQUVBO0FBQW1CO0FBQVEsSUFBdEMsZUFBZSxDQUFDLFNBQW9CO0FBQUksUUFDaEQsT0FBTywwQkFBMEIsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUNqRCxJQUFFLENBQUM7QUFDSDtBQUVDO0FBQ0c7QUFFSjtBQUFrQjtBQUE0QjtBQUMzQztBQUFRLElBREMsY0FBYyxDQUFDLFNBQW9CO0FBQUk7QUFDckMsWUFBTixPQUFPLEdBQUcsU0FBUyxDQUFDLE9BQU87QUFDbkMsUUFBSSxJQUFJLE9BQU8sQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO0FBQzlCLFlBQU0sT0FBTyxTQUFTLENBQUM7QUFDdkIsU0FBSztBQUNMO0FBQXlCLFlBQWpCLFVBQVUsR0FBRyxLQUFLO0FBQzFCLFFBQUksT0FBTyxHQUFHLG1CQUFBLE9BQU8sQ0FBQyxHQUFHO0FBQU07QUFDWDtBQUF1QjtBQUFZLFFBRDdCLENBQUMsSUFBSSxFQUFFLEVBQUU7QUFDbkMsWUFBTSxJQUFJLElBQUksQ0FBQyxFQUFFLEtBQUssUUFBUSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtBQUM1RCxnQkFBUSxVQUFVLEdBQUcsSUFBSSxDQUFDO0FBQzFCLGdCQUFRLHVDQUNLLElBQUksS0FDUCxRQUFRLEVBQUUsQ0FBQyxtQkFBQSxJQUFJLEVBQW1CLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRztBQUFNO0FBRXJEO0FBR1Q7QUFBd0Isb0JBTGlDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFDLElBQ2xFO0FBQ1YsYUFBTztBQUFDLGlCQUFLO0FBQ2IsZ0JBQVEsT0FBTyxJQUFJLENBQUM7QUFDcEIsYUFBTztBQUNQLFFBQUksQ0FBQyxFQUFDLEVBQW1CLENBQUM7QUFDMUIsUUFBSSxPQUFPLFVBQVUsQ0FBQyxDQUFDLGlDQUFNLFNBQVMsS0FBRSxPQUFPLElBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQztBQUM5RCxJQUFFLENBQUM7QUFDSDtBQUVDO0FBQ0c7QUFFSjtBQUFrQjtBQUE0QjtBQUMzQztBQUFRLElBREMsY0FBYyxDQUFDLFNBQW9CO0FBQUksUUFDL0MsSUFBSSxTQUFTLElBQUksSUFBSSxFQUFFO0FBQzNCLFlBQU0sMEhBQTBIO0FBQ2hJLFlBQU0sT0FBTyxTQUFTLENBQUM7QUFDdkIsU0FBSztBQUNMO0FBQXlCLFlBQWpCLE9BQU8sR0FBRyxTQUFTLENBQUMsT0FBTztBQUNuQyxRQUFJLElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7QUFDOUIsWUFBTSxPQUFPLFNBQVMsQ0FBQztBQUN2QixTQUFLO0FBQ0w7QUFBeUIsWUFBakIsVUFBVSxHQUFHLEtBQUs7QUFDMUIsUUFBSSxPQUFPLEdBQUcsbUJBQUEsT0FBTyxDQUFDLEdBQUc7QUFBTTtBQUNYO0FBQ1g7QUFBWSxRQUZLLENBQUMsSUFBSSxFQUFFLEVBQUU7QUFDbkMsWUFBTSxJQUFJLElBQUksQ0FBQyxFQUFFLEtBQUssUUFBUSxFQUFFO0FBQ2hDLGdCQUFRLDJEQUEyRDtBQUNuRSxnQkFBUSxVQUFVLEdBQUcsSUFBSSxDQUFDO0FBQzFCO0FBQWlDLHNCQUFuQixRQUFRLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO0FBQzVELGdCQUFRLE9BQU8sbURBQ0YsSUFBSSxLQUNQLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUc7QUFBTTtBQUNqQjtBQUVsQjtBQUNTLG9CQUpxQixDQUFDLENBQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztBQUNuRCx3QkFBWSxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUMzQix3QkFBWSxPQUFPLEVBQUUsQ0FBQztBQUN0QixxQkFBVyxDQUFDLEVBQUMsS0FDZSxDQUFDO0FBQzdCLGFBQU87QUFBQyxpQkFBSztBQUNiLGdCQUFRLE9BQU8sSUFBSSxDQUFDO0FBQ3BCLGFBQU87QUFDUCxRQUFJLENBQUMsRUFBQyxFQUFtQixDQUFDO0FBQzFCLFFBQUksT0FBTyxVQUFVLENBQUMsQ0FBQyxpQ0FBTSxTQUFTLEtBQUUsT0FBTyxJQUFHLENBQUMsQ0FBQyxTQUFTLENBQUM7QUFDOUQsSUFBRSxDQUFDO0FBQ0g7QUFFQztBQUNFO0FBQWtCO0FBRUE7QUFBbUI7QUFDeEMsSUFEWSxhQUFhLENBQUMsVUFBa0I7QUFDNUM7QUFBeUIsWUFBakIsVUFBVSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDO0FBQ2pELFFBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtBQUNyQixZQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQztBQUN6RSxpQkFBUyxRQUFRLENBQUM7QUFDbEIsWUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxHQUFHLFVBQVUsQ0FBQztBQUNoRCxTQUFLO0FBQ0wsUUFBSSxPQUFPLFVBQVUsQ0FBQztBQUN0QixJQUFFLENBQUM7QUFDSDtrREExSUMsVUFBVTtrSUFDVDtBQUFDO0FBQW1CO0FBQ1UsWUFYdkIsdUJBQXVCO0FBQUksWUFoQjNCLFVBQVU7QUFBSSxZQWVkLHdCQUF3Qix1QkFtQjVCLFFBQVE7QUFBTTs7Ozs7a0NBQUU7QUFBQztBQUFhO0FBQVE7QUFFdkM7QUFBa0I7QUFBUSxJQVQ1Qiw2Q0FBc0U7QUFDeEU7QUFBUTtBQUFpQjtBQUNUO0FBQVEsSUFEdEIsMkNBQXdCO0FBQzFCO0FBQVE7QUFDUjtBQUVFO0FBQVEsSUFIUix5Q0FBc0I7QUFDeEI7QUFDTztBQUNFO0FBQWtCO0FBQVEsSUFBL0IseURBQTBEO0FBQUM7QUFDeEQ7QUFBaUI7QUFDZDtBQUFRLElBRGQsc0NBQTBCO0FBQUM7QUFDOUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgZGVsYXksIG1hcCwgdGltZW91dCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgSWRTZWxlY3RvciB9IGZyb20gJ0BuZ3J4L2VudGl0eSc7XG5cbmltcG9ydCB7XG4gIENoYW5nZVNldE9wZXJhdGlvbixcbiAgQ2hhbmdlU2V0LFxuICBDaGFuZ2VTZXRJdGVtLFxuICBDaGFuZ2VTZXRVcGRhdGUsXG4gIGV4Y2x1ZGVFbXB0eUNoYW5nZVNldEl0ZW1zLFxufSBmcm9tICcuLi9hY3Rpb25zL2VudGl0eS1jYWNoZS1jaGFuZ2Utc2V0JztcbmltcG9ydCB7IERhdGFTZXJ2aWNlRXJyb3IgfSBmcm9tICcuL2RhdGEtc2VydmljZS1lcnJvcic7XG5pbXBvcnQgeyBEZWZhdWx0RGF0YVNlcnZpY2VDb25maWcgfSBmcm9tICcuL2RlZmF1bHQtZGF0YS1zZXJ2aWNlLWNvbmZpZyc7XG5pbXBvcnQgeyBFbnRpdHlEZWZpbml0aW9uU2VydmljZSB9IGZyb20gJy4uL2VudGl0eS1tZXRhZGF0YS9lbnRpdHktZGVmaW5pdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7IFJlcXVlc3REYXRhIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcblxuY29uc3QgdXBkYXRlT3AgPSBDaGFuZ2VTZXRPcGVyYXRpb24uVXBkYXRlO1xuXG4vKipcbiAqIERlZmF1bHQgZGF0YSBzZXJ2aWNlIGZvciBtYWtpbmcgcmVtb3RlIHNlcnZpY2UgY2FsbHMgdGFyZ2V0aW5nIHRoZSBlbnRpcmUgRW50aXR5Q2FjaGUuXG4gKiBTZWUgRW50aXR5RGF0YVNlcnZpY2UgZm9yIHNlcnZpY2VzIHRoYXQgdGFyZ2V0IGEgc2luZ2xlIEVudGl0eUNvbGxlY3Rpb25cbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEVudGl0eUNhY2hlRGF0YVNlcnZpY2Uge1xuICBwcm90ZWN0ZWQgaWRTZWxlY3RvcnM6IHsgW2VudGl0eU5hbWU6IHN0cmluZ106IElkU2VsZWN0b3I8YW55PiB9ID0ge307XG4gIHByb3RlY3RlZCBzYXZlRGVsYXkgPSAwO1xuICBwcm90ZWN0ZWQgdGltZW91dCA9IDA7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGVudGl0eURlZmluaXRpb25TZXJ2aWNlOiBFbnRpdHlEZWZpbml0aW9uU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgaHR0cDogSHR0cENsaWVudCxcbiAgICBAT3B0aW9uYWwoKSBjb25maWc/OiBEZWZhdWx0RGF0YVNlcnZpY2VDb25maWdcbiAgKSB7XG4gICAgY29uc3QgeyBzYXZlRGVsYXkgPSAwLCB0aW1lb3V0OiB0byA9IDAgfSA9IGNvbmZpZyB8fCB7fTtcbiAgICB0aGlzLnNhdmVEZWxheSA9IHNhdmVEZWxheTtcbiAgICB0aGlzLnRpbWVvdXQgPSB0bztcbiAgfVxuXG4gIC8qKlxuICAgKiBTYXZlIGNoYW5nZXMgdG8gbXVsdGlwbGUgZW50aXRpZXMgYWNyb3NzIG9uZSBvciBtb3JlIGVudGl0eSBjb2xsZWN0aW9ucy5cbiAgICogU2VydmVyIGVuZHBvaW50IG11c3QgdW5kZXJzdGFuZCB0aGUgZXNzZW50aWFsIFNhdmVFbnRpdGllcyBwcm90b2NvbCxcbiAgICogaW4gcGFydGljdWxhciB0aGUgQ2hhbmdlU2V0IGludGVyZmFjZSAoZXhjZXB0IGZvciBVcGRhdGU8VD4pLlxuICAgKiBUaGlzIGltcGxlbWVudGF0aW9uIGV4dHJhY3RzIHRoZSBlbnRpdHkgY2hhbmdlcyBmcm9tIGEgQ2hhbmdlU2V0IFVwZGF0ZTxUPltdIGFuZCBzZW5kcyB0aG9zZS5cbiAgICogSXQgdGhlbiByZWNvbnN0cnVjdHMgVXBkYXRlPFQ+W10gaW4gdGhlIHJldHVybmVkIG9ic2VydmFibGUgcmVzdWx0LlxuICAgKiBAcGFyYW0gY2hhbmdlU2V0ICBBbiBhcnJheSBvZiBTYXZlRW50aXR5SXRlbXMuXG4gICAqIEVhY2ggU2F2ZUVudGl0eUl0ZW0gZGVzY3JpYmUgYSBjaGFuZ2Ugb3BlcmF0aW9uIGZvciBvbmUgb3IgbW9yZSBlbnRpdGllcyBvZiBhIHNpbmdsZSBjb2xsZWN0aW9uLFxuICAgKiBrbm93biBieSBpdHMgJ2VudGl0eU5hbWUnLlxuICAgKiBAcGFyYW0gdXJsIFRoZSBzZXJ2ZXIgZW5kcG9pbnQgdGhhdCByZWNlaXZlcyB0aGlzIHJlcXVlc3QuXG4gICAqL1xuICBzYXZlRW50aXRpZXMoY2hhbmdlU2V0OiBDaGFuZ2VTZXQsIHVybDogc3RyaW5nKTogT2JzZXJ2YWJsZTxDaGFuZ2VTZXQ+IHtcbiAgICBjaGFuZ2VTZXQgPSB0aGlzLmZpbHRlckNoYW5nZVNldChjaGFuZ2VTZXQpO1xuICAgIC8vIEFzc3VtZSBzZXJ2ZXIgZG9lc24ndCB1bmRlcnN0YW5kIEBuZ3J4L2VudGl0eSBVcGRhdGU8VD4gc3RydWN0dXJlO1xuICAgIC8vIEV4dHJhY3QgdGhlIGVudGl0eSBjaGFuZ2VzIGZyb20gdGhlIFVwZGF0ZTxUPltdIGFuZCByZXN0b3JlIG9uIHRoZSByZXR1cm4gZnJvbSBzZXJ2ZXJcbiAgICBjaGFuZ2VTZXQgPSB0aGlzLmZsYXR0ZW5VcGRhdGVzKGNoYW5nZVNldCk7XG5cbiAgICBsZXQgcmVzdWx0JDogT2JzZXJ2YWJsZTxDaGFuZ2VTZXQ+ID0gdGhpcy5odHRwXG4gICAgICAucG9zdDxDaGFuZ2VTZXQ+KHVybCwgY2hhbmdlU2V0KVxuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgocmVzdWx0KSA9PiB0aGlzLnJlc3RvcmVVcGRhdGVzKHJlc3VsdCkpLFxuICAgICAgICBjYXRjaEVycm9yKHRoaXMuaGFuZGxlRXJyb3IoeyBtZXRob2Q6ICdQT1NUJywgdXJsLCBkYXRhOiBjaGFuZ2VTZXQgfSkpXG4gICAgICApO1xuXG4gICAgaWYgKHRoaXMudGltZW91dCkge1xuICAgICAgcmVzdWx0JCA9IHJlc3VsdCQucGlwZSh0aW1lb3V0KHRoaXMudGltZW91dCkpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnNhdmVEZWxheSkge1xuICAgICAgcmVzdWx0JCA9IHJlc3VsdCQucGlwZShkZWxheSh0aGlzLnNhdmVEZWxheSkpO1xuICAgIH1cblxuICAgIHJldHVybiByZXN1bHQkO1xuICB9XG5cbiAgLy8gI3JlZ2lvbiBoZWxwZXJzXG4gIHByb3RlY3RlZCBoYW5kbGVFcnJvcihyZXFEYXRhOiBSZXF1ZXN0RGF0YSkge1xuICAgIHJldHVybiAoZXJyOiBhbnkpID0+IHtcbiAgICAgIGNvbnN0IGVycm9yID0gbmV3IERhdGFTZXJ2aWNlRXJyb3IoZXJyLCByZXFEYXRhKTtcbiAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycm9yKTtcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEZpbHRlciBjaGFuZ2VTZXQgdG8gcmVtb3ZlIHVud2FudGVkIENoYW5nZVNldEl0ZW1zLlxuICAgKiBUaGlzIGltcGxlbWVudGF0aW9uIGV4Y2x1ZGVzIG51bGwgYW5kIGVtcHR5IENoYW5nZVNldEl0ZW1zLlxuICAgKiBAcGFyYW0gY2hhbmdlU2V0IENoYW5nZVNldCB3aXRoIGNoYW5nZXMgdG8gZmlsdGVyXG4gICAqL1xuICBwcm90ZWN0ZWQgZmlsdGVyQ2hhbmdlU2V0KGNoYW5nZVNldDogQ2hhbmdlU2V0KTogQ2hhbmdlU2V0IHtcbiAgICByZXR1cm4gZXhjbHVkZUVtcHR5Q2hhbmdlU2V0SXRlbXMoY2hhbmdlU2V0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0IHRoZSBlbnRpdGllcyBpbiB1cGRhdGUgY2hhbmdlcyBmcm9tIEBuZ3J4IFVwZGF0ZTxUPiBzdHJ1Y3R1cmUgdG8ganVzdCBULlxuICAgKiBSZXZlcnNlIG9mIHJlc3RvcmVVcGRhdGVzKCkuXG4gICAqL1xuICBwcm90ZWN0ZWQgZmxhdHRlblVwZGF0ZXMoY2hhbmdlU2V0OiBDaGFuZ2VTZXQpOiBDaGFuZ2VTZXQge1xuICAgIGxldCBjaGFuZ2VzID0gY2hhbmdlU2V0LmNoYW5nZXM7XG4gICAgaWYgKGNoYW5nZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gY2hhbmdlU2V0O1xuICAgIH1cbiAgICBsZXQgaGFzTXV0YXRlZCA9IGZhbHNlO1xuICAgIGNoYW5nZXMgPSBjaGFuZ2VzLm1hcCgoaXRlbSkgPT4ge1xuICAgICAgaWYgKGl0ZW0ub3AgPT09IHVwZGF0ZU9wICYmIGl0ZW0uZW50aXRpZXMubGVuZ3RoID4gMCkge1xuICAgICAgICBoYXNNdXRhdGVkID0gdHJ1ZTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAuLi5pdGVtLFxuICAgICAgICAgIGVudGl0aWVzOiAoaXRlbSBhcyBDaGFuZ2VTZXRVcGRhdGUpLmVudGl0aWVzLm1hcCgodSkgPT4gdS5jaGFuZ2VzKSxcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBpdGVtO1xuICAgICAgfVxuICAgIH0pIGFzIENoYW5nZVNldEl0ZW1bXTtcbiAgICByZXR1cm4gaGFzTXV0YXRlZCA/IHsgLi4uY2hhbmdlU2V0LCBjaGFuZ2VzIH0gOiBjaGFuZ2VTZXQ7XG4gIH1cblxuICAvKipcbiAgICogQ29udmVydCB0aGUgZmxhdHRlbmVkIFQgZW50aXRpZXMgaW4gdXBkYXRlIGNoYW5nZXMgYmFjayB0byBAbmdyeCBVcGRhdGU8VD4gc3RydWN0dXJlcy5cbiAgICogUmV2ZXJzZSBvZiBmbGF0dGVuVXBkYXRlcygpLlxuICAgKi9cbiAgcHJvdGVjdGVkIHJlc3RvcmVVcGRhdGVzKGNoYW5nZVNldDogQ2hhbmdlU2V0KTogQ2hhbmdlU2V0IHtcbiAgICBpZiAoY2hhbmdlU2V0ID09IG51bGwpIHtcbiAgICAgIC8vIE5vdGhpbmc/IFNlcnZlciBwcm9iYWJseSByZXNwb25kZWQgd2l0aCAyMDQgLSBObyBDb250ZW50IGJlY2F1c2UgaXQgbWFkZSBubyBjaGFuZ2VzIHRvIHRoZSBpbnNlcnRlZCBvciB1cGRhdGVkIGVudGl0aWVzXG4gICAgICByZXR1cm4gY2hhbmdlU2V0O1xuICAgIH1cbiAgICBsZXQgY2hhbmdlcyA9IGNoYW5nZVNldC5jaGFuZ2VzO1xuICAgIGlmIChjaGFuZ2VzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIGNoYW5nZVNldDtcbiAgICB9XG4gICAgbGV0IGhhc011dGF0ZWQgPSBmYWxzZTtcbiAgICBjaGFuZ2VzID0gY2hhbmdlcy5tYXAoKGl0ZW0pID0+IHtcbiAgICAgIGlmIChpdGVtLm9wID09PSB1cGRhdGVPcCkge1xuICAgICAgICAvLyBUaGVzZSBhcmUgZW50aXRpZXMsIG5vdCBVcGRhdGVzOyBjb252ZXJ0IGJhY2sgdG8gVXBkYXRlc1xuICAgICAgICBoYXNNdXRhdGVkID0gdHJ1ZTtcbiAgICAgICAgY29uc3Qgc2VsZWN0SWQgPSB0aGlzLmdldElkU2VsZWN0b3IoaXRlbS5lbnRpdHlOYW1lKTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAuLi5pdGVtLFxuICAgICAgICAgIGVudGl0aWVzOiBpdGVtLmVudGl0aWVzLm1hcCgodTogYW55KSA9PiAoe1xuICAgICAgICAgICAgaWQ6IHNlbGVjdElkKHUpLFxuICAgICAgICAgICAgY2hhbmdlczogdSxcbiAgICAgICAgICB9KSksXG4gICAgICAgIH0gYXMgQ2hhbmdlU2V0VXBkYXRlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGl0ZW07XG4gICAgICB9XG4gICAgfSkgYXMgQ2hhbmdlU2V0SXRlbVtdO1xuICAgIHJldHVybiBoYXNNdXRhdGVkID8geyAuLi5jaGFuZ2VTZXQsIGNoYW5nZXMgfSA6IGNoYW5nZVNldDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGlkIChwcmltYXJ5IGtleSkgc2VsZWN0b3IgZnVuY3Rpb24gZm9yIGFuIGVudGl0eSB0eXBlXG4gICAqIEBwYXJhbSBlbnRpdHlOYW1lIG5hbWUgb2YgdGhlIGVudGl0eSB0eXBlXG4gICAqL1xuICBwcm90ZWN0ZWQgZ2V0SWRTZWxlY3RvcihlbnRpdHlOYW1lOiBzdHJpbmcpIHtcbiAgICBsZXQgaWRTZWxlY3RvciA9IHRoaXMuaWRTZWxlY3RvcnNbZW50aXR5TmFtZV07XG4gICAgaWYgKCFpZFNlbGVjdG9yKSB7XG4gICAgICBpZFNlbGVjdG9yID0gdGhpcy5lbnRpdHlEZWZpbml0aW9uU2VydmljZS5nZXREZWZpbml0aW9uKGVudGl0eU5hbWUpXG4gICAgICAgIC5zZWxlY3RJZDtcbiAgICAgIHRoaXMuaWRTZWxlY3RvcnNbZW50aXR5TmFtZV0gPSBpZFNlbGVjdG9yO1xuICAgIH1cbiAgICByZXR1cm4gaWRTZWxlY3RvcjtcbiAgfVxuICAvLyAjZW5kcmVnaW9uIGhlbHBlcnNcbn1cbiJdfQ==